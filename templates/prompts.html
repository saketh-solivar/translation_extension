<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Story Legacy</title>
    <style>
                /* ===== Modern Header Layout ===== */
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(90deg, rgb(69,205,239), #6c63ff);
            padding: 20px 40px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .logo {
            font-size: 32px;
            font-weight: bold;
            color: white;
        }

        /* ===== Country Dropdown Styling ===== */
        .country-wrapper {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .country-wrapper label {
            font-size: 14px;
            color: white;
            margin-bottom: 5px;
            font-weight: 600;
        }

        #langSelect {
            padding: 10px 16px;
            font-size: 15px;
            border-radius: 25px;
            border: none;
            outline: none;
            background-color: white;
            color: #333;
            min-width: 220px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
        }

        /* Hover Effect */
        #langSelect:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }

        /* Focus Effect */
        #langSelect:focus {
            box-shadow: 0 0 0 3px rgba(108,99,255,0.4);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-bar {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
        }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f4f4f9;
        }
        header {
            background-color: rgb(69, 205, 239);
            font-weight: bold;
            font-size: 40px;
            padding: 20px;
        }
        .main-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .prompt-container, .audio-container {
            width: 80%;
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .button {
            padding: 10px 20px;
            background-color: #6c63ff;
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
        }
        .stop-button {
            background-color: red;
        }
        #instructionModal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        #instructionContent {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 900px;
            width: 90%;
        }
        #instructionText {
            font-size: 22px;
            line-height: 1.6;
        }
        #langSelect {
            padding: 8px 12px;
            font-size: 16px;
            border-radius: 5px;
            border: 2px solid #6c63ff;
            background-color: white;
            cursor: pointer;
            min-width: 200px;
        }
        #langSelect option {
            padding: 8px;
            font-size: 16px;
        }
    </style>
</head>

<body>
<header class="header-bar">
    <div class="logo">Story Legacy</div>

    <div class="country-wrapper">
        <label for="langSelect">üåç Country</label>
        <select id="langSelect"></select>
    </div>
</header>



<div class="main-container">

    <!-- Instructions Modal -->
    <div id="instructionModal">
        <div id="instructionContent">
            <div id="instructionText"></div>
            <button id="closeInstruction" class="button">Close</button>
        </div>
    </div>

    <div class="prompt-container">
        <div id="prompt"></div>
    </div>

    <div class="audio-container" id="audioSection">
        <button id="start" class="button" onclick="startRecording()">Start Recording</button>
        <button id="stop" class="button stop-button" onclick="stopRecording()" style="display:none;">Stop</button>
        <audio id="audioPlayer" controls hidden></audio>
        <button id="erase" class="button" onclick="eraseRecording()" style="display:none;">Re-record</button>
    </div>

    <button id="next" class="button" style="display:none;">Next</button>
</div>

<script>
    // {{INJECT_START_STATE}}

    let prompts = [];
    let questions = [];
    let additionalQuestionsMap = {};
    let currentPromptIndex = 0;
    let isPromptPhase = true;
    let isAdditionalPhase = false;
    let additionalIndex = 0;

    /* üîë LANGUAGE FROM URL */
    const params = new URLSearchParams(window.location.search);
    const lang = params.get("lang") || "en";

    function getQueryParameter(name) {
        return new URLSearchParams(window.location.search).get(name);
    }

    async function initializeSession() {
        await fetchPrompts();
    }

    async function fetchPrompts() {
        const project_code = getQueryParameter("pc");

        const response = await fetch(
            `/prompts_and_questions?project_code=${project_code}&lang=${lang}`
        );

        const data = await response.json();

        prompts = data.prompts;
        questions = data.questions;
        additionalQuestionsMap = data.additional_questions;
        const instructions = data.instructions;

        if (instructions) {
            document.getElementById("instructionText").innerHTML = instructions;
            document.getElementById("instructionModal").style.display = "flex";
        }

        setInitialState();
        displayContent();
    }

    function setInitialState() {
  if (typeof resumeState !== "undefined") {
    isPromptPhase = resumeState.phase === "prompt" || resumeState.phase === "aqg";
    isAdditionalPhase = resumeState.phase === "aqg";
    currentPromptIndex = resumeState.prompt_index || 0;
    additionalIndex = resumeState.additional_index || 0;
  } else {
    isPromptPhase = true;
    isAdditionalPhase = false;
    currentPromptIndex = 0;
    additionalIndex = 0;
  }
}


    function displayContent() {
        const promptEl = document.getElementById("prompt");
        const nextBtn = document.getElementById("next");

        let item = isPromptPhase ? prompts[currentPromptIndex] : questions[currentPromptIndex];

        if (!item) {
            showThankYou();
            return;
        }

        promptEl.innerHTML = `<h3>${item.Questions}</h3>`;
        nextBtn.style.display = "inline-block";
    }

    function showThankYou() {
        document.body.innerHTML = "<h2 style='text-align:center;margin-top:20%'>Thank you for participating!</h2>";
    }

    document.getElementById("next").addEventListener("click", () => {
        currentPromptIndex++;
        displayContent();
    });

    document.getElementById("closeInstruction").onclick = () => {
        document.getElementById("instructionModal").style.display = "none";
    };

    
    

    function getCountryLanguageName(langCode) {
    const countryLanguageMap = {
        'en': 'üá∫üá∏ United States',
        'es': 'üá™üá∏ Spain',
        'fr': 'üá´üá∑ France',
        'de': 'üá©üá™ Germany',
        'it': 'üáÆüáπ Italy',
        'pt': 'üáµüáπ Portugal',
        'pt-br': 'üáßüá∑ Brazil',
        'zh': 'üá®üá≥ China',
        'zh-cn': 'üá®üá≥ China',
        'zh-tw': 'üáπüáº Taiwan',
        'ja': 'üáØüáµ Japan',
        'ko': 'üá∞üá∑ South Korea',
        'ar': 'üá∏üá¶ Saudi Arabia',
        'hi': 'üáÆüá≥ India',
        'te': 'üáÆüá≥ India (Telugu)',
        'ta': 'üáÆüá≥ India (Tamil)',
        'kn': 'üáÆüá≥ India (Kannada)',
        'ml': 'üáÆüá≥ India (Malayalam)',
        'ru': 'üá∑üá∫ Russia',
        'nl': 'üá≥üá± Netherlands',
        'pl': 'üáµüá± Poland',
        'tr': 'üáπüá∑ Turkey',
        'th': 'üáπüá≠ Thailand',
        'vi': 'üáªüá≥ Vietnam',
        'id': 'üáÆüá© Indonesia',
        'sv': 'üá∏üá™ Sweden',
        'no': 'üá≥üá¥ Norway',
        'da': 'üá©üá∞ Denmark',
        'fi': 'üá´üáÆ Finland',
        'el': 'üá¨üá∑ Greece',
        'he': 'üáÆüá± Israel',
        'uk': 'üá∫üá¶ Ukraine'
    };

    return countryLanguageMap[langCode.toLowerCase()] || langCode.toUpperCase();
}

    async function loadLanguages() {
  const params = new URLSearchParams(window.location.search);
  const projectCode = params.get("pc");
  const currentLang = params.get("lang") || "en";

  const res = await fetch(`/available_languages?project_code=${projectCode}`);
  const data = await res.json();

  const select = document.getElementById("langSelect");
  select.innerHTML = "";

  data.languages.forEach(lang => {
    const option = document.createElement("option");
    option.value = lang.code;
    const countryLanguageName = getCountryLanguageName(lang.code);
    option.textContent = countryLanguageName;
    if (lang.code === currentLang) option.selected = true;
    select.appendChild(option);
  });

  select.onchange = () => {
    params.set("lang", select.value);
    window.location.search = params.toString();
  };
}


window.onload = async () => {
  await loadLanguages();
  await initializeSession();
};

// ---------------- AUDIO RECORDING LOGIC ----------------

let mediaRecorder;
let audioChunks = [];
let recordedBlob = null;

async function startRecording() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = event => {
            if (event.data.size > 0) {
                audioChunks.push(event.data);
            }
        };

        mediaRecorder.onstop = async () => {
            recordedBlob = new Blob(audioChunks, { type: "audio/webm" });

            const audioURL = URL.createObjectURL(recordedBlob);
            const audioPlayer = document.getElementById("audioPlayer");
            audioPlayer.src = audioURL;
            audioPlayer.hidden = false;

            document.getElementById("erase").style.display = "inline-block";

            await uploadAudio();
        };

        mediaRecorder.start();

        document.getElementById("start").style.display = "none";
        document.getElementById("stop").style.display = "inline-block";

    } catch (err) {
        alert("Microphone access denied or not supported.");
        console.error(err);
    }
}

function stopRecording() {
    if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
    }

    document.getElementById("stop").style.display = "none";
    document.getElementById("start").style.display = "inline-block";
}

function eraseRecording() {
    const audioPlayer = document.getElementById("audioPlayer");
    audioPlayer.src = "";
    audioPlayer.hidden = true;

    recordedBlob = null;
    audioChunks = [];

    document.getElementById("erase").style.display = "none";
}

// ---------------- UPLOAD TO BACKEND ----------------

async function uploadAudio() {
    if (!recordedBlob) return;

    const project_code = getQueryParameter("pc");
    const session_id = getQueryParameter("id");

    const formData = new FormData();
    formData.append("file", recordedBlob);
    formData.append("project_code", project_code);
    formData.append("session_id", session_id);
    formData.append("prompt_index", currentPromptIndex);
    formData.append("file_extension", "webm");
    formData.append("is_prompt", isPromptPhase);
    formData.append("is_additional", false);
    formData.append("additional_index", 0);
    formData.append("duration_seconds", 0);

    try {
        const response = await fetch("/save_audio", {
            method: "POST",
            body: formData
        });

        const result = await response.json();

        if (result.error) {
            console.error(result.error);
            alert("Upload failed.");
        } else {
            console.log("Audio uploaded successfully.");
        }
    } catch (err) {
        console.error("Upload error:", err);
    }
}
</script>

</body>
</html>
