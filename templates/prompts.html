<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Story Legacy</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f4f4f9;
        }
        header {
            background-color: rgb(69, 205, 239);
            font-weight: bold;
            font-size: 40px;
            padding: 20px;
        }
        .main-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .prompt-container, .audio-container {
            width: 80%;
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .button {
            padding: 10px 20px;
            background-color: #6c63ff;
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
        }
        .stop-button {
            background-color: red;
        }
        #instructionModal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        #instructionContent {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 900px;
            width: 90%;
        }
        #instructionText {
            font-size: 22px;
            line-height: 1.6;
        }
    </style>
</head>

<body>
<header>Story Legacy</header>

<div style="margin:20px;text-align:right;">
  <label for="langSelect"><b>Language:</b></label>
  <select id="langSelect"></select>
</div>



<div class="main-container">

    <!-- Instructions Modal -->
    <div id="instructionModal">
        <div id="instructionContent">
            <div id="instructionText"></div>
            <button id="closeInstruction" class="button">Close</button>
        </div>
    </div>

    <div class="prompt-container">
        <div id="prompt"></div>
    </div>

    <div class="audio-container" id="audioSection">
        <button id="start" class="button" onclick="startRecording()">Start Recording</button>
        <button id="stop" class="button stop-button" onclick="stopRecording()" style="display:none;">Stop</button>
        <audio id="audioPlayer" controls hidden></audio>
        <button id="erase" class="button" onclick="eraseRecording()" style="display:none;">Re-record</button>
    </div>

    <button id="next" class="button" style="display:none;">Next</button>
</div>

<script>
    // {{INJECT_START_STATE}}

    let prompts = [];
    let questions = [];
    let additionalQuestionsMap = {};
    let currentPromptIndex = 0;
    let isPromptPhase = true;
    let isAdditionalPhase = false;
    let additionalIndex = 0;

    /* ðŸ”‘ LANGUAGE FROM URL */
    const params = new URLSearchParams(window.location.search);
    const lang = params.get("lang") || "en";

    function getQueryParameter(name) {
        return new URLSearchParams(window.location.search).get(name);
    }

    async function initializeSession() {
        await fetchPrompts();
    }

    async function fetchPrompts() {
        const project_code = getQueryParameter("pc");

        const response = await fetch(
            `/prompts_and_questions?project_code=${project_code}&lang=${lang}`
        );

        const data = await response.json();

        prompts = data.prompts;
        questions = data.questions;
        additionalQuestionsMap = data.additional_questions;
        const instructions = data.instructions;

        if (instructions) {
            document.getElementById("instructionText").innerHTML = instructions;
            document.getElementById("instructionModal").style.display = "flex";
        }

        setInitialState();
        displayContent();
    }

    function setInitialState() {
  if (typeof resumeState !== "undefined") {
    isPromptPhase = resumeState.phase === "prompt" || resumeState.phase === "aqg";
    isAdditionalPhase = resumeState.phase === "aqg";
    currentPromptIndex = resumeState.prompt_index || 0;
    additionalIndex = resumeState.additional_index || 0;
  } else {
    isPromptPhase = true;
    isAdditionalPhase = false;
    currentPromptIndex = 0;
    additionalIndex = 0;
  }
}


    function displayContent() {
        const promptEl = document.getElementById("prompt");
        const nextBtn = document.getElementById("next");

        let item = isPromptPhase ? prompts[currentPromptIndex] : questions[currentPromptIndex];

        if (!item) {
            showThankYou();
            return;
        }

        promptEl.innerHTML = `<h3>${item.Questions}</h3>`;
        nextBtn.style.display = "inline-block";
    }

    function showThankYou() {
        document.body.innerHTML = "<h2 style='text-align:center;margin-top:20%'>Thank you for participating!</h2>";
    }

    document.getElementById("next").addEventListener("click", () => {
        currentPromptIndex++;
        displayContent();
    });

    document.getElementById("closeInstruction").onclick = () => {
        document.getElementById("instructionModal").style.display = "none";
    };

    async function loadLanguages() {
  const params = new URLSearchParams(window.location.search);
  const projectCode = params.get("pc");
  const currentLang = params.get("lang") || "en";

  const res = await fetch(`/available_languages?project_code=${projectCode}`);
  const data = await res.json();

  const select = document.getElementById("langSelect");
  select.innerHTML = "";

  data.languages.forEach(lang => {
    const option = document.createElement("option");
    option.value = lang.code;
    option.textContent = lang.label;
    if (lang.code === currentLang) option.selected = true;
    select.appendChild(option);
  });

  select.onchange = () => {
    params.set("lang", select.value);
    window.location.search = params.toString();
  };
}


window.onload = async () => {
  await loadLanguages();
  await initializeSession();
};
</script>

</body>
</html>
